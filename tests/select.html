<!DOCTYPE html>
<html>
<head>

	<meta http-equiv="Content-type" content="text/html; charset=utf-8">

	<title>dforma from schema</title>
<!--[if lt IE 9]>
<script src="/js_shared/html5shiv.js"></script>
<![endif]-->
	<link rel="stylesheet" type="text/css" href="../../dijit/themes/claro/claro.css" />
	<link rel="stylesheet" type="text/css" href="../resources/Builder.css" />
	<style>
		.dformaLabel {
			margin:6px;
		}
		.dformaLabelNode {
			display:block;
			text-align:left;
			min-width: 100px;
		}
		.dformaLabel:last-child{
			clear:right;
		}
		.dformaGroup, .dformaRepeat {
			clear:both;
			margin:10px;
		}
		.dformaGroupLabel, .dformaRepeatLabel {
			font-weight:bold;
		}
		.dformaBuilderForm > .dformaLabel:first-child {
			display:block;
		}
		.dformaBuilderForm > .dformaLabel:first-child .dformaLabelNode {
			display:inline-block;
			width:100px;
		}
		/*.dformaCancel {
			float:right;
		}
		.dformaSubmit {
			float:right;
		}*/
		.dijitTextArea {
			width:400px;
		}
		.dgrid {
			max-width:500px;
			max-height:200px;
		}
	</style>
	<script type="text/javascript" src="../../dojo/dojo.js" data-dojo-config="async: true,locale:'nl-nl',extraLocale:['en-us']"></script>
	<script type="text/javascript">
		require([
			"dojo/_base/lang",
			"dojo/_base/array",
			"dforma/Builder", 
			"dojo/json", 
			"dojo/store/Memory",
			"dojo/store/Observable",
			"dojo/dom-construct",
			"dojo/dom-class",
			"dojo/dom",
			"dojo/ready",
			"dojo/hash",
			"dojo/topic",
			"dojox/mobile/i18n",
			"dojo/text!./nl.json",
			"dojo/text!./en.json"
		], function(lang,array,Builder,JSON,Memory,Observable,domConstruct,domClass,dom,ready,hash,topic,i18n,lang_nl,lang_en){
			function traverse(obj,func, parent) {
				for (i in obj){
					func.apply(obj,[i,obj[i],parent]);
					if (obj[i] instanceof Object && !(obj[i] instanceof Array)) {
						traverse(obj[i],func, i);
					} else if(obj[i] instanceof Array) {
						array.forEach(obj[i],function(o){
							traverse(o,func, i);
						});
					}
				}
			};
			function replaceNlsRecursive(obj,nls){
				traverse(obj, function(key, value, parent){
					if(typeof value == "string" && value.indexOf("{")>-1){
						this[key] = lang.replace(value,nls);
					}
				});
				return obj;
			};
			var nls = {
				"en-us":lang_en,
				"nl-nl":lang_nl
			};
			var select;
			function rebuild() {
				var schema = {
					"id":"verhuur",
					"type":"array",
					"format":"list",
					"title":"{rental}",
					"items":[{
						"id":"uitvoeringsmateriaal",
						"title":"{concert_material}",
						"type" : "object",
						"properties":{
							"componist" : {
								"title": "{composer}",
								"required" : true,
								"type" : "string"
							},
							"titel" : {
								"title": "{title}",
								"required" : true,
								"type" : "string"
							},
							"uitgever" : {
								"title": "{publisher}",
								"type" : "string"
							},
							"materialen" : {
								"title": "{material_type}",
								"type" : "object",
								"properties":{
									"pianouittreksel":{
										"type":"integer",
										"minimum":0,
										"default":0
									},
									"koormateriaal":{
										"type":"integer",
										"minimum":0,
										"default":0
									}
								}
							},
							"strijkers" : {
								"title": "{string_set}",
								"description":"{no_strings_info}",
								"type" : "object",
								"properties":{
									"viool1":{
										"title": "{violin1}",
										"type":"integer",
										"minimum":0,
										"default":0
									},
									"viool2":{
										"title": "{violin2}",
										"type":"integer",
										"minimum":0,
										"default":0
									},
									"altviool":{
										"title": "{viola}",
										"type":"integer",
										"minimum":0,
										"default":0
									},
									"cello":{
										"title": "{violoncello}",
										"type":"integer",
										"minimum":0,
										"default":0
									},
									"contrabas":{
										"title": "{double_bass}",
										"type":"integer",
										"minimum":0,
										"default":0
									}
								}
							},
							"uitvoeringen":{
								"title": "{performances}",
								"description":"{performance_info}",
								"type":"array",
								"minItems":1,
								"items":{
									"datum" : {
										"title": "{date}",
										"required" : true,
										"type" : "date"
									},
									"plaats" : {
										"title": "{place}",
										"required" : true,
										"type" : "string"
									},
									"zaal" : {
										"title": "{location}",
										"required" : true,
										"type" : "string"
									}
								}
							},
							"dirigent":{
								"title": "{conductor}",
								"type":"string"
							},
							"solisten":{
								"title": "{soloists}",
								"type":"string"
							},
							"eersterepetitie":{
								"title": "{first_rehearsal}",
								"type":"date"
							},
							"opnames":{
								"title":"{recording}",
								"description":"{add_recording_info}",
								"type":"object",
								"properties":{
									"radio":{
										"type":"boolean"
									},
									"tv":{
										"type":"boolean"
									},
									"cd-dvd":{
										"title":"{cd_dvd}",
										"type":"boolean"
									},
									"internet":{
										"type":"boolean"
									},
									"overig":{
										"title":"{other}",
										"type":"boolean"
									}
								}
							},
							"opmerkingen" : {
								"title": "{remarks}",
								"type" : "string",
								"format" : "text"
							}
						}
					},{
						"id":"zichtpartituur",
						"type":"object",
						"title" : "{perusal_score}",
						"properties":{
							"componist" : {
								"title": "{composer}",
								"required" : true,
								"type" : "string"
							},
							"titel" : {
								"title": "{title}",
								"required" : true,
								"type" : "string"
							},
							"uitgever" : {
								"title": "{publisher}",
								"type" : "string"
							},
							"opmerkingen" : {
								"title": "{remarks}",
								"type" : "string",
								"format" : "text"
							}
						}
					}]
				};
				var columns = {
			        componist: {
			            label: "{composer}"
			        },
			        titel: {
			            label: "{title}"
			        }
			    };
				var h = hash();
				if(h) dojo.locale = h;
				if(select) select.destroyRecursive();
				var common = i18n.load("dforma","common");
				schema = replaceNlsRecursive(schema,JSON.parse(nls[dojo.locale]));
				columns = replaceNlsRecursive(columns,JSON.parse(nls[dojo.locale]));
				select = new Builder({
					store:Observable(new Memory({
						identifier: "id"
					})),
					submit: function(){
						if(!this.validate()) return;
						var data = this.store.query();
						domConstruct.create("div",{
							innerHTML:"<pre>"+JSON.stringify(data,null,2)+"</pre>"
							//style:"color:"+(valid ?"green" : "red")
						},"data");
					}
				}).placeAt("select");
				select.startup();
				select.rebuild({
					controls:[{
						type:"list",
						name:schema.title,
						columns: columns,
						schemas:schema.items,
						controller:{
							type:"select",
							name:"aanvraagtype"
						},
					    defaultInstance:{
					    	componist:"",
					    	titel:""
					    }
					}]
				});
			}
			ready(rebuild);
			topic.subscribe("/dojo/hashchange",function(){
				rebuild();
			});
		});

	</script>
</head>
<body class="claro">
		<h3>Form from JSON Schema</h3>
		<div><a href="#nl-nl">Nederlands</a> / <a href="#en-us">Engels</a></div>
		<div id="select"></div>
		<div id="form"></div>
		<div id="data"></div>
</body>
</html>
