<!DOCTYPE html>
<html>
<head>

	<meta http-equiv="Content-type" content="text/html; charset=utf-8">

	<title>dforma from schema</title>
<!--[if lt IE 9]>
<script src="/js_shared/html5shiv.js"></script>
<![endif]-->
	<link rel="stylesheet" type="text/css" href="../../dijit/themes/claro/claro.css" />
	<link rel="stylesheet" type="text/css" href="../resources/Builder.css" />
	<style>
		.dformaLabel {
			margin:6px;
		}
		.dformaLabelNode {
			display:block;
			text-align:left;
			min-width: 100px;
		}
		.dformaLabel:last-child{
			clear:right;
		}
		.dformaGroup, .dformaRepeat {
			clear:both;
			margin:10px;
		}
		.dformaGroupLabel, .dformaRepeatLabel {
			font-weight:bold;
		}
		.dformaBuilderForm > .dformaLabel:first-child {
			display:block;
		}
		.dformaBuilderForm > .dformaLabel:first-child .dformaLabelNode {
			display:inline-block;
			width:100px;
		}
		/*.dformaCancel {
			float:right;
		}
		.dformaSubmit {
			float:right;
		}*/
		.dijitTextArea {
			width:400px;
		}
		.dgrid {
			max-width:500px;
			max-height:200px;
		}
	</style>
	<script type="text/javascript" src="../../dojo/dojo.js" data-dojo-config="async: true,locale:'nl-nl',extraLocale:['en-us']"></script>
	<script type="text/javascript">
		require([
			"dojo/_base/lang",
			"dojo/_base/array",
			"dforma/Builder", 
			"dojo/json", 
			"dojo/store/Memory",
			"dojo/store/Observable",
			"dojo/dom-construct",
			"dojo/dom-class",
			"dojo/dom",
			"dojo/ready",
			"dojo/hash",
			"dojo/topic",
			"dojo/i18n!dforma/nls/common",
			"dojo/text!./nl.json",
			"dojo/text!./en.json"
		], function(lang,array,Builder,JSON,Memory,Observable,domConstruct,domClass,dom,ready,hash,topic,common,lang_nl,lang_en){
			function traverse(obj,func, parent) {
				for (i in obj){
					func.apply(obj,[i,obj[i],parent]);
					if (obj[i] instanceof Object && !(obj[i] instanceof Array)) {
						traverse(obj[i],func, i);
					}
				}
			};
			function replaceNlsRecursive(obj,nls){
				traverse(obj, function(key, value, parent){
					if(typeof value == "string" && value.indexOf("{")>-1){
						this[key] = lang.replace(value,nls);
					}
				});
				return obj;
			};
			dojo.locale = hash() || "nl";
			var locale = dojo.locale.split("_").pop();
			var nls = {
				en:lang_en,
				nl:lang_nl
			};
			var schemas = [{
				"title" : "{concert_material}",
				"properties":{
					"componist" : {
						"title": "{composer}",
						"required" : true,
						"type" : "string"
					},
					"titel" : {
						"title": "{title}",
						"required" : true,
						"type" : "string"
					},
					"uitgever" : {
						"title": "{publisher}",
						"type" : "string"
					},
					"materialen" : {
						"title": "{material_type}",
						"type" : "object",
						"properties":{
							"pianouittreksel":{
								"type":"integer",
								"default":0
							},
							"koormateriaal":{
								"type":"integer",
								"default":0
							}
						}
					},
					"strijkers" : {
						"title": "{string_set}",
						"description":"{no_strings_info}",
						"type" : "object",
						"properties":{
							"viool1":{
								"title": "{violin1}",
								"type":"integer",
								"default":0
							},
							"viool2":{
								"title": "{violin2}",
								"type":"integer",
								"default":0
							},
							"altviool":{
								"title": "{viola}",
								"type":"integer",
								"default":0
							},
							"cello":{
								"title": "{violoncello}",
								"type":"integer",
								"default":0
							},
							"contrabas":{
								"title": "{double_bass}",
								"type":"integer",
								"default":0
							}
						}
					},
					"uitvoeringen":{
						"title": "{performances}",
						"description":"{performance_info}",
						"type":"array",
						"minItems":1,
						"items":{
							"datum" : {
								"title": "{date}",
								"required" : true,
								"type" : "date"
							},
							"plaats" : {
								"title": "{place}",
								"required" : true,
								"type" : "string"
							},
							"zaal" : {
								"title": "{location}",
								"required" : true,
								"type" : "string"
							}
						}
					},
					"dirigent":{
						"title": "{conductor}",
						"type":"string"
					},
					"solisten":{
						"title": "{soloists}",
						"type":"string"
					},
					"eersterepetitie":{
						"title": "{first_rehearsal}",
						"type":"date"
					},
					"opnames":{
						"title":"{recording}",
						"description":"{add_recording_info}",
						"type":"object",
						"properties":{
							"radio":{
								"type":"boolean"
							},
							"tv":{
								"type":"boolean"
							},
							"cd-dvd":{
								"title":"{cd_dvd}",
								"type":"boolean"
							},
							"internet":{
								"type":"boolean"
							},
							"overig":{
								"title":"{other}",
								"type":"boolean"
							}
						}
					},
					"opmerkingen" : {
						"title": "{remarks}",
						"type" : "string",
						"format" : "text"
					}
				}
			},{
				"type" : "{perusal_score}",
				"properties":{
					"componist" : {
						"title": "{composer}",
						"required" : true,
						"type" : "string"
					},
					"titel" : {
						"title": "{title}",
						"required" : true,
						"type" : "string"
					},
					"uitgever" : {
						"title": "{publisher}",
						"type" : "string"
					},
					"opmerkingen" : {
						"title": "{remarks}",
						"type" : "string",
						"format" : "text"
					}
				}
			}];
			
			schemas = array.map(schemas,function(schema){
				return replaceNlsRecursive(schema,JSON.parse(nls[locale]));
			});
			var columns = {
		        componist: {
		            label: "{composer}"
		        },
		        titel: {
		            label: "{title}"
		        }
		    };
			columns = replaceNlsRecursive(columns,JSON.parse(nls[locale]));
			var select = new dforma.Builder({
				store:Observable(new Memory({
					identifier: "id"
				})),
				submit: function(){
					if(!this.validate()) return;
					var data = this.store.query();
					domConstruct.create("div",{
						innerHTML:"<pre>"+JSON.stringify(data,null,2)+"</pre>"
						//style:"color:"+(valid ?"green" : "red")
					},"data");
				}
			}).placeAt("select");
			select.startup();
			select.rebuild({
				controls:[{
					type:"list",
					name:"verhuur",
					store:select.store,
					columns: columns,
				    defaultInstance:{
				    	componist:"",
				    	titel:""
				    },
					onEdit:function(id,options){
						options = options || {};
						var self = this;
						var data = this.store.get(id);
						domClass.toggle(select.domNode,"dijitHidden",true);
						domClass.toggle(fb.domNode,"dijitHidden",false);
						var control = fb.toControl("type",schemas,data,{
							selectFirst:true
						});
						fb.rebuild({
							id:id,
							options:options,
							controls:[control],
							submit:{
								label:common.buttonSave
							}
						});
					}
				}]
			});
			var fb = new dforma.Builder({
				cancel: function(){
					domClass.toggle(select.domNode,"dijitHidden",false);
					domClass.toggle(fb.domNode,"dijitHidden",true);
					// cancelled new?
					if(!this.data.options.overwrite) select.store.remove(this.data.id);
				},
				submit: function(){
					if(!this.validate()) return;
					domClass.toggle(select.domNode,"dijitHidden",false);
					domClass.toggle(fb.domNode,"dijitHidden",true);
					var data = this.get("value");
					var schema = this.get("controllerWidget").item.schema;
					select.store.put(data,{
						id:this.data.id,
						overwrite:true
					});
				}
			}).placeAt("form");
			fb.startup();
			topic.subscribe("/dojo/hashchange",function(){
			});
		});

	</script>
</head>
<body class="claro">
		<h3>Form from JSON Schema</h3>
		<div><a href="#nl">Nederlands</a> / <a href="#en">Engels</a></div>
		<div id="select"></div>
		<div id="form"></div>
		<div id="data"></div>
</body>
</html>
