<!DOCTYPE html>
<html>
<head>

	<meta http-equiv="Content-type" content="text/html; charset=utf-8">

	<title>dforma from schema</title>
<!--[if lt IE 9]>
<script src="/js_shared/html5shiv.js"></script>
<![endif]-->
	<link rel="stylesheet" type="text/css" href="../../dijit/themes/claro/claro.css" />
	<link rel="stylesheet" type="text/css" href="../resources/Builder.css" />
	<style>
		.dformaLabel {
			margin:6px;
		}
		.dformaLabelNode {
			display:block;
			text-align:left;
			min-width: 100px;
		}
		.dformaLabel:last-child{
			clear:right;
		}
		.dformaGroup, .dformaRepeat {
			clear:both;
			margin:10px;
		}
		.dformaGroupLabel, .dformaRepeatLabel {
			font-weight:bold;
		}
		.dformaBuilderForm > .dformaLabel:first-child {
			display:block;
		}
		.dformaBuilderForm > .dformaLabel:first-child .dformaLabelNode {
			display:inline-block;
			width:100px;
		}
		.dformaCancel {
			display:none;
		}
		.dijitTextArea {
			width:400px;
		}
		.dformaSubmit {
			float:right;
		}
	</style>
	<script type="text/javascript" src="../../dojo/dojo.js" data-dojo-config="async: true,locale:'nl-nl',extraLocale:['en-us']"></script>
	<script type="text/javascript">
		require([
			"dojo/_base/lang",
			"dojo/_base/array",
			"dforma/Builder",
			"dforma/jsonschema",
			"dojo/json", 
			"dojo/store/Memory", 
			"dojo/dom-construct",
			"dojo/dom",
			"dojo/ready",
			"dojo/hash",
			"dojo/topic",
			"dojo/text!./nl.json",
			"dojo/text!./en.json"
		], function(lang,array,Builder,jsonschema,JSON,Memory,domConstruct,dom,ready,hash,topic,lang_nl,lang_en){
			function traverse(obj,func, parent) {
				for (i in obj){
					func.apply(obj,[i,obj[i],parent]);
					if (obj[i] instanceof Object && !(obj[i] instanceof Array)) {
						traverse(obj[i],func, i);
					}
				}
			};
			function replaceNlsRecursive(obj,nls){
				traverse(obj, function(key, value, parent){
					if(typeof value == "string" && value.indexOf("{")>-1){
						this[key] = lang.replace(value,nls);
					}
				});
				return obj;
			};
			var fb = new dforma.Builder({
				store:new Memory(),
				hideOptional:false,
				allowOptionalDeletion:false,
				allowFreeKey:false,
				cancel: function(){
					myDialog.hide();
				},
				submit: function(){
					if(!this.validate()) return;
					var data = this.get("value");
					var schema = this.get("controllerWidget").item.schema;
					//var jsonvalid = jsonschema.validate(data,schema);
					//var valid = jsonvalid.errors.length == 0;
					//console.log(jsonvalid)
					//var validtext = valid ? "This data is valid" : jsonvalid.errors.map(function(_){return _.message});
					//if(!valid) {
					//	alert(validtext);
					//	return;
					//}
					// submit data
					var valid = true;
					this.store.put(data);
					domConstruct.create("div",{
						innerHTML:JSON.stringify(data,null,2),
						style:"color:"+(valid ?"green" : "red")
					},"data");
				}
			}).placeAt("form");
			fb.startup();
			function loadFB(){
				var data;
				var nls = {
					en:lang_en,
					nl:lang_nl
				};
				var locale = hash() || "nl";
				dojo.locale = locale;
				var schemas = [{
					"type" : "{concert_material}",
					"title" : "{concert_material}",
					"properties":{
						"componist" : {
							"title": "{composer}",
							"required" : true,
							"type" : "string"
						},
						"titel" : {
							"title": "{title}",
							"required" : true,
							"type" : "string"
						},
						"uitgever" : {
							"title": "{publisher}",
							"type" : "string"
						},
						"materialen" : {
							"title": "{material_type}",
							"type" : "object",
							"properties":{
								"pianouittreksel":{
									"type":"integer",
									"default":0
								},
								"koormateriaal":{
									"type":"integer",
									"default":0
								}
							}
						},
						"strijkers" : {
							"title": "{string_set}",
							"description":"{no_strings_info}",
							"type" : "object",
							"properties":{
								"viool1":{
									"title": "{violin1}",
									"type":"integer",
									"default":0
								},
								"viool2":{
									"title": "{violin2}",
									"type":"integer",
									"default":0
								},
								"altviool":{
									"title": "{viola}",
									"type":"integer",
									"default":0
								},
								"cello":{
									"title": "{violoncello}",
									"type":"integer",
									"default":0
								},
								"contrabas":{
									"title": "{double_bass}",
									"type":"integer",
									"default":0
								}
							}
						},
						"uitvoeringen":{
							"title": "{performances}",
							"description":"{performance_info}",
							"type":"array",
							"minItems":1,
							"items":{
								"datum" : {
									"title": "{date}",
									"required" : true,
									"type" : "date"
								},
								"plaats" : {
									"title": "{place}",
									"required" : true,
									"type" : "string"
								},
								"zaal" : {
									"title": "{location}",
									"required" : true,
									"type" : "string"
								}
							}
						},
						"dirigent":{
							"title": "{conductor}",
							"type":"string"
						},
						"solisten":{
							"title": "{soloists}",
							"type":"string"
						},
						"eersterepetitie":{
							"title": "{first_rehearsal}",
							"type":"date"
						},
						"opnames":{
							"title":"{recording}",
							"description":"{add_recording_info}",
							"type":"object",
							"properties":{
								"radio":{
									"type":"boolean"
								},
								"tv":{
									"type":"boolean"
								},
								"cd-dvd":{
									"title":"{cd_dvd}",
									"type":"boolean"
								},
								"internet":{
									"type":"boolean"
								},
								"overig":{
									"title":"{other}",
									"type":"boolean"
								}
							}
						},
						"opmerkingen" : {
							"title": "{remarks}",
							"type" : "string",
							"format" : "text"
						}
					}
				},{
					"type" : "{perusal_score}",
					"title" : "{perusal_score}",
					"properties":{
						"componist" : {
							"title": "{composer}",
							"required" : true,
							"type" : "string"
						},
						"titel" : {
							"title": "{title}",
							"required" : true,
							"type" : "string"
						},
						"uitgever" : {
							"title": "{publisher}",
							"type" : "string"
						},
						"opmerkingen" : {
							"title": "{remarks}",
							"type" : "string",
							"format" : "text"
						}
					}
				}];
				schemas = array.map(schemas,function(schema){
					return replaceNlsRecursive(schema,JSON.parse(nls[locale]));
				});
				dom.byId("schema").innerHTML = "<pre>"+JSON.stringify(schemas,null,2)+"</pre>";
				var control = jsonschema.schemasToControl("type",schemas,data,{
					selectFirst:true
				});
				fb.rebuild({
					controls:[control]
				});
			}
			ready(loadFB);
			topic.subscribe("/dojo/hashchange",function(){
				loadFB();
			});
		});

	</script>
</head>
<body class="claro">
		<h3>Form from JSON Schema</h3>
		<div><a href="#nl">Nederlands</a> / <a href="#en">English</a></div>
		<div id="form"></div>
		<div id="data"></div>
		<div id="schema">
			<h4>Schema:</h4>
		</div>
</body>
</html>
